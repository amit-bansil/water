/*
 * CREATED ON:    Apr 23, 2006 5:47:37 PM
 * CREATED BY:    Amit Bansil 
 */
package cps.water.simulation;

import cps.jarch.data.value.tools.BoundedValue;
import cps.jarch.util.collections.ArrayFinal;
import cps.jarch.util.collections.CursorableLinkedList;
import cps.jarch.util.notes.Constant;

import java.util.Iterator;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * <p>TODO document OutputParameters
 * </p>
 * @version $Id$
 * @author Amit Bansil
 */
public class OutputParameters {
	private final ReentrantReadWriteLock lock;

	private final BoundedValue<Integer> recordStepSize;
	private final BoundedValue<Integer> maxRecordingCount;

	private int recordStep=-1,recordCount=-1,frameNumber=-1;
	
	public OutputParameters(ReentrantReadWriteLock lock) {
		this.lock=lock;

		recordStepSize=new BoundedValue<Integer>(5,1,500,lock);
		maxRecordingCount=new BoundedValue<Integer>(200,50,500,lock);
	}
	
	
	void preStep() {
		if(lock.getReadLockCount()<11)throw new IllegalThreadStateException();
		
		recordStep = recordStepSize.get();
		recordCount = maxRecordingCount.get();
	}
	
	void step(Engine raw) {
		assert recordStep!=-1&&frameNumber!=-1;
		
		frameNumber++;
		if (frameNumber == nextRecord) {
			ArrayFinal.Builder<Float> recordingBuilder = new ArrayFinal.Builder<Float>(
					dataSets.getLength());
			
			recordingBuilder.add((float)raw.temp);
			recordingBuilder.add((float)raw.rho);
			recordingBuilder.add((float)raw.pres);
			recordingBuilder.add((float)raw.epot);
			recordingBuilder.add((float)raw.ekin);
			recordingBuilder.add((float)raw.eges);
			recordingBuilder.add((float)(raw.bx*raw.by*raw.bz));
			recordingBuilder.add((float)frameNumber);
				
			recordings.addLast(recordingBuilder.create());
			nextRecord += recordStep;
		}
	}
	void postStep() {
		for (int excessRecordings = recordCount - getRecordingCount(); excessRecordings > 0;
		excessRecordings--)  recordings.removeFirst();
	}

	
	private int nextRecord;
	private final CursorableLinkedList recordings=new CursorableLinkedList();
	
	private static final ArrayFinal<String> dataSets = ArrayFinal.create(
		new String[] {"Temperature",
				"Density",
				"Pressure",
				"Potential Energy",
				"Kinetic Energy",
				"Total Energy",
				"Volume",
				"Time"});
	
	public final @Constant BoundedValue<Integer> maxRecordingCount(){
		return maxRecordingCount;
	}
	public final @Constant BoundedValue<Integer> recordStepSize(){
		return recordStepSize;
	}
	
	public final @Constant ArrayFinal<String> getRecordingElementNames(){
		return dataSets;
	}
	
	@SuppressWarnings("unchecked") public final Iterator<ArrayFinal<Float>> getRecordings(){
		return recordings.listIterator();
	}
	public final int getRecordingCount() {	
		return recordings.size();
	}

}
